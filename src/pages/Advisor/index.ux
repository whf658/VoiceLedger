<template>
  <div class="page">
    <div class="header">
      <text class="header-title">AI ç§äººç†è´¢é¡¾é—®</text>
      <text class="header-sub">åŸºäº DeepSeek V3 & æœ¬åœ°æ•°æ®</text>
    </div>

    <scroll class="chat-scroll" scroll-y="true" id="chatList">
      <div class="chat-container">
        <div class="msg-group" for="{{ item in messages }}">
          <div
            class="msg-row {{ item.role === 'user' ? 'msg-right' : 'msg-left' }}"
          >
            <div
              class="avatar {{ item.role === 'user' ? 'avatar-user' : 'avatar-ai' }}"
            >
              <text class="avatar-text">{{
                item.role === 'user' ? 'æˆ‘' : 'AI'
              }}</text>
            </div>

            <div
              class="bubble {{ item.role === 'user' ? 'bubble-user' : 'bubble-ai' }}"
            >
              <text class="bubble-text">{{ item.content }}</text>
            </div>
          </div>
        </div>
      </div>
    </scroll>

    <div class="chips-area" if="{{ messages.length < 2 }}">
      <div class="chip" onclick="quickAsk('åˆ†æä¸€ä¸‹æˆ‘æœ¬æœˆçš„æ¶ˆè´¹æƒ…å†µ')">
        <text class="chip-text">ğŸ“Š æœ¬æœˆæ¶ˆè´¹åˆ†æ</text>
      </div>
      <div class="chip" onclick="quickAsk('æˆ‘çš„é’±éƒ½èŠ±å“ªå„¿äº†ï¼Ÿç»™ç‚¹å»ºè®®')">
        <text class="chip-text">ğŸ’¡ ç»™ç‚¹çœé’±å»ºè®®</text>
      </div>
    </div>

    <div class="input-area">
      <input
        class="chat-input"
        type="text"
        placeholder="é—®é—® AI..."
        value="{{ inputText }}"
        onchange="onInputChange"
      />
      <div class="send-btn" onclick="sendUserMessage()">
        <text class="send-icon">â¤</text>
      </div>
    </div>
  </div>
</template>

<script>
import fetch from '@system.fetch'
import prompt from '@system.prompt'

export default {
  data: {
    inputText: '',
    bills: [],
    messages: [
      {
        role: 'ai',
        content:
          'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½ç†è´¢é¡¾é—®ã€‚æˆ‘å·²ç»è¯»å–äº†ä½ çš„è®°è´¦æ•°æ®ï¼Œæƒ³äº†è§£ä»€ä¹ˆï¼Ÿ',
      },
    ],
    isLoading: false,
  },

  onShow() {
    this.loadContextData()
  },

  loadContextData() {
    var self = this
    if (typeof $services === 'undefined' || !$services.storage) return

    $services.storage.getBills().then(function (list) {
      self.bills = (list || []).slice(0, 50)
    })
  },

  onInputChange(e) {
    this.inputText = e.value
  },

  quickAsk(text) {
    this.inputText = text
    this.sendUserMessage()
  },

  sendUserMessage() {
    if (!this.inputText.trim()) return
    if (this.isLoading) {
      prompt.showToast({ message: 'AI æ­£åœ¨æ€è€ƒä¸­...' })
      return
    }

    var userMsg = this.inputText
    this.messages.push({ role: 'user', content: userMsg })
    this.inputText = ''

    this.callDeepSeek(userMsg)
  },

  callDeepSeek(userQuestion) {
    this.isLoading = true
    this.messages.push({ role: 'ai', content: 'åˆ†æä¸­...' })

    var self = this

    var billContext = JSON.stringify(
      this.bills.map((b) => ({
        d: b.date,
        c: b.category,
        a: b.amount,
        desc: b.desc,
      }))
    )

    var systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è´¢åŠ¡åˆ†æå¸ˆã€‚æ•°æ®ï¼š${billContext}
    è¦æ±‚ï¼š
    1. é£æ ¼å¹½é»˜é£è¶£ã€‚
    2. å›ç­”æ§åˆ¶åœ¨200å­—ä»¥å†…ã€‚
    3. ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨Markdownï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬ã€‚
    4. é‡ç‚¹ä¿¡æ¯ç›´æ¥è¯´ã€‚`

    var API_URL = 'https://api.deepseek.com/chat/completions'
    var API_KEY = 'sk-*****'

    fetch.fetch({
      url: API_URL,
      method: 'POST',
      header: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${API_KEY}`,
      },
      data: JSON.stringify({
        model: 'deepseek-chat',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userQuestion },
        ],
        stream: false,
      }),
      success: function (response) {
        try {
          var resObj = JSON.parse(response.data)
          var aiReply = resObj.choices[0].message.content

          self.messages.pop()
          self.messages.push({ role: 'ai', content: aiReply })
        } catch (e) {
          self.messages.pop()
          self.messages.push({
            role: 'ai',
            content: 'æˆ‘å¥½åƒæœ‰ç‚¹æ™•ï¼Œè¯·ç¨åå†è¯•ã€‚',
          })
        }
        self.isLoading = false
      },
      fail: function (err) {
        self.messages.pop()
        self.messages.push({ role: 'ai', content: 'ç½‘ç»œè¿æ¥å¤±è´¥ã€‚' })
        self.isLoading = false
      },
    })
  },
}
</script>

<style lang="less">
.page {
  flex: 1;
  background-color: #050505;
  flex-direction: column;
}

.header {
  height: 120px;
  background-color: #141414;
  flex-direction: column;
  justify-content: center;
  padding: 0 30px;
  border-bottom-width: 1px;
  border-bottom-color: #222;
  flex-shrink: 0;
}
.header-title {
  color: #fff;
  font-size: 32px;
  font-weight: bold;
}
.header-sub {
  color: #666;
  font-size: 22px;
  margin-top: 6px;
}

/* 1. Scroll ç»„ä»¶ï¼šå æ»¡å‰©ä½™ç©ºé—´ */
.chat-scroll {
  flex: 1;
}

/* 2. å†…éƒ¨å®¹å™¨ï¼šå…³é”®ï¼å¼ºåˆ¶æ‰€æœ‰æ¶ˆæ¯ç«–å‘æ’åˆ— */
.chat-container {
  flex-direction: column; /* å‚ç›´å †å  */
  padding: 30px;
}

/* 3. æ¯ä¸€ç»„æ¶ˆæ¯å— */
.msg-group {
  flex-direction: column;
  width: 100%; /* å æ»¡å®½åº¦ï¼Œé˜²æ­¢å·¦å³å¹¶æ’ */
  margin-bottom: 30px;
}

/* 4. æ¶ˆæ¯è¡Œå†…å¸ƒå±€ï¼šæ§åˆ¶å¤´åƒå’Œæ°”æ³¡çš„å·¦å³å…³ç³» */
.msg-row {
  flex-direction: row;
  align-items: flex-start;
  width: 100%;
}

.msg-left {
  justify-content: flex-start; /* AIï¼šå·¦å¯¹é½ */
}

.msg-right {
  flex-direction: row-reverse; /* ç”¨æˆ·ï¼šåå‘æ’åˆ—(å³å¯¹é½) */
  justify-content: flex-start;
}

/* å¤´åƒ */
.avatar {
  width: 80px;
  height: 80px;
  border-radius: 40px;
  justify-content: center;
  align-items: center;
  margin: 0 20px;
  flex-shrink: 0;
}
.avatar-ai {
  background-color: #2979ff;
}
.avatar-user {
  background-color: #ff9100;
}
.avatar-text {
  color: #fff;
  font-size: 28px;
  font-weight: bold;
}

/* æ°”æ³¡ */
.bubble {
  max-width: 500px;
  padding: 24px;
  border-radius: 24px;
  flex-direction: column;
}
.bubble-ai {
  background-color: #1f1f1f;
  border-top-left-radius: 4px;
}
.bubble-user {
  background-color: #4b70f5;
  border-top-right-radius: 4px;
}
.bubble-text {
  color: #e5ecff;
  font-size: 28px;
  line-height: 40px;
}

/* åº•éƒ¨åŒºåŸŸä¿æŒä¸å˜ */
.chips-area {
  height: 100px;
  flex-direction: row;
  padding: 0 20px;
  align-items: center;
  background-color: #0a0a0a;
  flex-shrink: 0;
}
.chip {
  background-color: #1f1f1f;
  border: 1px solid #333;
  padding: 10px 24px;
  border-radius: 30px;
  margin-right: 16px;
}
.chip-text {
  color: #888;
  font-size: 24px;
}

.input-area {
  height: 120px;
  background-color: #141414;
  flex-direction: row;
  align-items: center;
  padding: 0 30px;
  flex-shrink: 0;
}
.chat-input {
  flex: 1;
  height: 80px;
  background-color: #000;
  border-radius: 40px;
  padding: 0 30px;
  color: #fff;
  font-size: 28px;
  border: 1px solid #333;
}
.send-btn {
  width: 80px;
  height: 80px;
  justify-content: center;
  align-items: center;
  margin-left: 20px;
  background-color: #2979ff;
  border-radius: 40px;
}
.send-icon {
  color: #fff;
  font-size: 40px;
}
</style>
