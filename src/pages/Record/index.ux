<template>
  <div class="page">
    <div class="header">
      <div class="header-left">
        <text class="title">AI è®°è´¦åŠ©æ‰‹</text>
        <div class="status-pill {{ status === 'listening' || status === 'thinking' ? 'pulsing' : '' }}">
          <div class="status-dot"></div>
          <text class="status-text">{{ statusText }}</text>
        </div>
      </div>
    </div>

    <div class="wave-card">
      <div class="bars-container" if="{{ status === 'listening' || status === 'thinking' }}">
         <div class="bar b1"></div>
         <div class="bar b2"></div>
         <div class="bar b3"></div>
         <div class="bar b4"></div>
         <div class="bar b5"></div>
      </div>
      <text class="instruction" if="{{ status === 'idle' }}">ç‚¹å‡»éº¦å…‹é£è¯´è¯ï¼Œæˆ–ç›´æ¥è¾“å…¥æ–‡å­—</text>
      
      <div class="input-area">
        <text class="label">æ¶ˆè´¹/æ”¶å…¥æè¿°</text>
        <div class="input-row">
          <input
            class="main-input"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šå‘äº†å·¥èµ„5000å…ƒ"
            value="{{ transcript }}"
            onchange="onTranscriptChange"
          />
          <div class="mic-btn {{ status === 'listening' ? 'mic-active' : '' }}" onclick="toggleAsr()">
            <text class="mic-icon">ğŸ¤</text>
          </div>
        </div>
      </div>
    </div>

    <div class="form-card">
      <div class="form-header">
        <text class="form-title">ğŸ“ è¯†åˆ«æ˜ç»†</text>
        <text class="loading-text" if="{{ loading }}">AI æ€è€ƒä¸­...</text>
      </div>

      <div class="type-switch">
        <div class="type-btn {{ form.type === 'expense' ? 'active-expense' : '' }}" onclick="switchType('expense')">
          <text class="type-text {{ form.type === 'expense' ? 'text-active' : '' }}">æ”¯å‡º</text>
        </div>
        <div class="type-btn {{ form.type === 'income' ? 'active-income' : '' }}" onclick="switchType('income')">
          <text class="type-text {{ form.type === 'income' ? 'text-active' : '' }}">æ”¶å…¥</text>
        </div>
      </div>

      <div class="form-grid">
        <div class="field-group full-width">
          <text class="field-label">é‡‘é¢ (Â¥)</text>
          <input
            class="field-input amount-input {{ form.type === 'income' ? 'green-text' : 'orange-text' }}"
            type="number"
            placeholder="0.00"
            value="{{ form.amount }}"
            onchange="onAmountChange"
          />
        </div>

        <div class="field-group half-width">
          <text class="field-label">åˆ†ç±»</text>
          <input
            class="field-input"
            type="text"
            placeholder="é¤é¥®/å·¥èµ„"
            value="{{ form.category }}"
            onchange="onCategoryChange"
          />
        </div>

        <div class="field-group half-width">
          <text class="field-label">æ—¥æœŸ</text>
          <input
            class="field-input"
            type="text"
            value="{{ form.date }}"
            onchange="onDateChange"
          />
        </div>

        <div class="field-group full-width">
          <text class="field-label">å¤‡æ³¨</text>
          <input
            class="field-input"
            type="text"
            placeholder="æ— å¤‡æ³¨"
            value="{{ form.desc }}"
            onchange="onDescChange"
          />
        </div>
      </div>
    </div>

    <div class="bottom-actions">
      <div class="btn-secondary" onclick="parseText()">
        <text class="btn-text-sec">âœ¨ AI è§£æ</text>
      </div>
      <div class="btn-primary" onclick="saveBill()">
        <text class="btn-text-pri">ç¡®è®¤ä¿å­˜</text>
      </div>
    </div>
  </div>
</template>

<script>
import router from '@system.router'
import asr from '@service.asr'
import vibrator from '@system.vibrator'
import prompt from '@system.prompt'

export default {
  data: {
    status: 'idle',
    statusText: 'å¾…å‘½',
    transcript: '',
    loading: false,
    form: { amount: '', category: '', desc: '', date: '', type: 'expense' },
    nameBackUp: '',
    settings: { vibrate: true, autoSave: false }
  },

  onInit() {
    // ğŸ› ï¸ ä¿®å¤1: é€‚é… app.ux çš„å…¨å±€æŒ‚è½½
    // ä¸è¦ç”¨ this.$utilsï¼Œç›´æ¥æ£€æŸ¥å…¨å±€å¯¹è±¡ $utils æ˜¯å¦å­˜åœ¨
    if (typeof $utils !== 'undefined' && $utils.dateWithOffset) {
        this.form.date = $utils.dateWithOffset(0);
    } else {
        // å¦‚æœå·¥å…·ç±»æ²¡åŠ è½½æˆåŠŸï¼Œç»™ä¸€ä¸ªé»˜è®¤å½“å‰æ—¥æœŸï¼Œé˜²æ­¢ç©ºç™½
        const now = new Date();
        this.form.date = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    }
    this.initAsr();
  },

  onShow() {
    this.loadSettings();
    this._syncStatusText();
  },

  onHide() {
    this.stopAsr();
  },

  initAsr() {
    let that = this; 
    if (!asr || !asr.start) return;
    
    asr.oncompleteresult = function ({ result }) {
      that.transcript = that.nameBackUp + `${result}`;
      that.status = 'idle';
      that._syncStatusText();
      that.doVibrate();
    }
  },

  // å°è£…éœ‡åŠ¨æ–¹æ³•ï¼Œé˜²æ­¢æŸäº›æœºå‹ä¸æ”¯æŒæŠ¥é”™
  doVibrate() {
    try { vibrator.vibrate({ mode: 'short' }); } catch (e) {}
  },

  startAsr() {
    let that = this; 
    if (!asr || !asr.start) return;

    this.nameBackUp = this.transcript;
    this.status = 'listening';
    this._syncStatusText();

    asr.start({
      success: function() { that.doVibrate(); },
      fail: function(data, code) {
        console.error(`ASR Error: ${code}`);
        that.status = 'idle';
        that._syncStatusText();
        that.transcript = `å¯åŠ¨å¤±è´¥: ${code}`;
      }
    });
  },

  toggleAsr() {
    if (this.status === 'listening') this.stopAsr();
    else this.startAsr();
  },

  stopAsr() {
    if (asr && asr.stop) asr.stop();
    if (this.status === 'listening') {
      this.status = 'idle';
      this._syncStatusText();
    }
  },

  parseText() {
    if (!this.transcript) return;
    this.status = 'thinking';
    this.loading = true;
    this._syncStatusText();
    this.handleAI(this.transcript);
  },

  handleAI(text) {
    var self = this
    
    // ğŸ› ï¸ ä¿®å¤2: å®‰å…¨æ£€æŸ¥ $servicesï¼Œé˜²æ­¢ ReferenceError å¯¼è‡´ç™½å±
    if (typeof $services === 'undefined' || !$services.ai) {
        console.error("Services not ready");
        self.loading = false;
        self.status = 'ready';
        self._syncStatusText();
        // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªæç¤º Toast
        return;
    }

    $services.ai.parseBill(text).then(function(parsed) {
        var normalized = $services.ai.normalizeBill(parsed, text)
        self.form = { 
          amount: normalized.amount || '', 
          category: normalized.category || '', 
          desc: normalized.desc || '', 
          date: normalized.date || self.form.date,
          type: normalized.type 
        }
        self.status = 'ready'; 
        self.loading = false; 
        self._syncStatusText();
        
        if (self.settings.autoSave && normalized.amount) {
          self.saveBill();
        }
      }).catch(function(err) { 
        console.error(err);
        self.status = 'ready'; 
        self.loading = false; 
        self._syncStatusText();
      })
  },

  switchType(type) { this.form.type = type; },
  
  _getInputValue(e) { 
    if (!e) return ''; 
    if (e.value != null) return e.value; 
    if (e.detail && e.detail.value != null) return e.detail.value; 
    return ''; 
  },
  
  onTranscriptChange(e) { this.transcript = this._getInputValue(e); },
  onAmountChange(e) { this.form.amount = this._getInputValue(e) },
  onCategoryChange(e) { this.form.category = this._getInputValue(e) },
  onDescChange(e) { this.form.desc = this._getInputValue(e) },
  onDateChange(e) { this.form.date = this._getInputValue(e) },

  saveBill() {
    var self = this;
    var amount = Number(this.form.amount)
    if (!amount || amount <= 0) return;
    
    var bill = { 
      id: '' + Date.now(), 
      type: this.form.type, 
      amount: amount, 
      category: this.form.category || (this.form.type === 'income' ? 'æ”¶å…¥' : 'å…¶ä»–'), 
      desc: this.form.desc || this.transcript, 
      rawText: this.transcript, 
      date: this.form.date 
    }
    
    // ğŸ› ï¸ ä¿®å¤3: åŒæ ·çš„å®‰å…¨æ£€æŸ¥
    if (typeof $services !== 'undefined' && $services.storage) {
        $services.storage.addBill(bill).then(function() {
            if (self.settings.vibrate) try { vibrator.vibrate({ mode: 'short' }); } catch(e){}
            
            prompt.showToast({
              message: 'ä¿å­˜æˆåŠŸ'
            })
            
            // æ¸…ç©ºä¸Šä¸€æ¡è®°å½•ï¼Œä¿ç•™æ—¥æœŸå’Œç±»å‹
            self.transcript = ''
            self.form.amount = ''
            self.form.category = ''
            self.form.desc = ''
        })
    } else {
        console.error("$services.storage missing");
    }
  },

  _syncStatusText() { 
    var map = { idle: 'å¾…å‘½', listening: 'å½•éŸ³ä¸­', thinking: 'æ€è€ƒä¸­', ready: 'å°±ç»ª' }; 
    this.statusText = map[this.status] || 'å¾…å‘½'; 
  },
  
  loadSettings() { 
    var self = this; 
    // ğŸ› ï¸ ä¿®å¤4: è¿™æ˜¯å¯¼è‡´ç™½å±çš„æœ€å¤§å«Œç–‘çŠ¯
    // å¿…é¡»ç”¨ typeof æ£€æŸ¥ï¼Œå¦åˆ™å¦‚æœ $services ä¸å­˜åœ¨ç›´æ¥æŠ¥é”™å´©æºƒ
    if(typeof $services !== 'undefined' && $services.storage) {
      $services.storage.getSettings().then(function(s) { 
        self.settings = s || { vibrate: true, autoSave: false } 
      }).catch(e => console.error("Load settings failed", e));
    }
  }
}
</script>

<style lang="less">
.page {
  flex: 1;
  background-color: #050505;
  padding: 30px;
  flex-direction: column;
}

.header { margin-bottom: 30px; }
.header-left { flex-direction: row; align-items: center; }
.title { color: #fff; font-size: 36px; font-weight: bold; margin-right: 20px; }

/* çŠ¶æ€è¯ä¸¸ */
.status-pill {
  background-color: #1A1A1A;
  border-radius: 30px;
  padding: 6px 16px;
  flex-direction: row;
  align-items: center;
  border: 1px solid #333;
}
.pulsing { border-color: #00E5FF; }
.status-dot {
  width: 12px; height: 12px; border-radius: 6px;
  background-color: #00E5FF; margin-right: 10px;
}
.status-text { color: #ccc; font-size: 22px; }

/* æ ¸å¿ƒè¾“å…¥å¡ç‰‡ */
.wave-card {
  background-color: #141414;
  border-radius: 32px;
  padding: 30px;
  margin-bottom: 30px;
  flex-direction: column;
}

.instruction { color: #666; font-size: 24px; text-align: center; margin-bottom: 20px; }

.bars-container {
  height: 80px; width: 100%;
  justify-content: center; align-items: center; margin-bottom: 20px;
}
.bar {
  width: 8px; background-color: #2979FF; border-radius: 4px; margin: 0 6px; height: 20px;
  animation-name: wave; animation-iteration-count: infinite;
}
.b1 { animation-duration: 0.6s; }
.b2 { animation-duration: 0.8s; }
.b3 { animation-duration: 1.0s; height: 40px; }
.b4 { animation-duration: 0.8s; }
.b5 { animation-duration: 0.6s; }

@keyframes wave {
  0% { height: 20px; opacity: 0.5; }
  50% { height: 60px; opacity: 1; background-color: #00E5FF; }
  100% { height: 20px; opacity: 0.5; }
}

.input-area { flex-direction: column; }
.label { color: #888; font-size: 22px; margin-bottom: 10px; }

.input-row { flex-direction: row; align-items: center; }

.main-input {
  flex: 1; 
  background-color: #000;
  border-radius: 16px;
  padding: 20px;
  color: #fff;
  font-size: 28px;
  placeholder-color: #444;
  margin-right: 20px; 
}

.mic-btn {
  width: 90px; height: 90px;
  background-color: #1F1F1F;
  border-radius: 45px;
  justify-content: center; align-items: center;
  border: 1px solid #333;
}
.mic-active {
  background-color: #FF9100;
  border-color: #FF9100;
  animation-name: pulse;
  animation-duration: 1.5s;
  animation-iteration-count: infinite;
}
.mic-icon { font-size: 40px; }

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* è¡¨å•å¡ç‰‡ */
.form-card {
  background-color: #141414;
  border-radius: 32px;
  padding: 30px;
  flex: 1; 
  flex-direction: column;
}
.form-header { flex-direction: row; justify-content: space-between; margin-bottom: 20px; }
.form-title { color: #fff; font-size: 30px; font-weight: bold; }
.loading-text { color: #2979FF; font-size: 24px; }

/* ğŸŸ¢ æ”¶æ”¯åˆ‡æ¢å™¨æ ·å¼ */
.type-switch {
  flex-direction: row;
  background-color: #000;
  border-radius: 16px;
  padding: 6px;
  margin-bottom: 30px;
}
.type-btn {
  flex: 1;
  height: 60px;
  justify-content: center;
  align-items: center;
  border-radius: 12px;
}
.active-expense { background-color: #FF4D4F; } /* çº¢ */
.active-income { background-color: #00B578; } /* ç»¿ */
.type-text { color: #666; font-size: 26px; }
.text-active { color: #fff; font-weight: bold; }

.form-grid { flex-direction: row; flex-wrap: wrap; justify-content: space-between; }
.field-group { flex-direction: column; margin-bottom: 24px; }
.full-width { width: 100%; }
.half-width { width: 48%; }

.field-label { color: #666; font-size: 22px; margin-bottom: 8px; }
.field-input {
  background-color: #000; border-radius: 16px; padding: 18px;
  color: #fff; font-size: 26px; placeholder-color: #444;
}
.orange-text { color: #FF9100; font-weight: bold; font-size: 32px; }
.green-text { color: #00B578; font-weight: bold; font-size: 32px; }

/* åº•éƒ¨æŒ‰é’® */
.bottom-actions { flex-direction: row; justify-content: space-between; margin-top: 30px; }
.btn-secondary {
  width: 32%; height: 90px; background-color: #222; border-radius: 24px;
  justify-content: center; align-items: center;
}
.btn-primary {
  width: 64%; height: 90px;
  background: linear-gradient(to right, #2979FF, #651FFF);
  border-radius: 24px;
  justify-content: center; align-items: center;
}
.btn-text-sec { color: #ccc; font-size: 28px; }
.btn-text-pri { color: #fff; font-size: 30px; font-weight: bold; }
</style>
